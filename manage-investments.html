<!DOCTYPE html>
<html lang="ml" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Returns</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        body { font-family: 'Poppins', sans-serif; background: var(--bg-gradient); min-height: 100vh; padding-top: 80px; padding-bottom: 70px; }
        
        .top-controls { position: fixed; top: 0; width: 100%; background: white; padding: 15px; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        
        .inv-item { background: rgba(255,255,255,0.95); border-radius: 12px; margin: 10px 15px; padding: 15px; border-left: 5px solid #8b5cf6; }
        .inv-header { display: flex; justify-content: space-between; font-weight: 600; margin-bottom: 5px; }
        
        .paid-row { border-left-color: #10b981; background: #f0fdf4; }
        .footer { position: fixed; bottom: 0; width: 100%; height: 50px; background: white; display: flex; justify-content: center; align-items: center; z-index: 1000; }
    </style>
</head>
<body>

    <div class="top-controls">
        <h5 class="fw-bold mb-2">Return Payments</h5>
        <input type="date" id="returnDate" class="form-control">
    </div>

    <div id="invList">
        </div>

    <footer class="footer">
        <i class="fas fa-home fs-4 text-secondary" onclick="window.location.href='admin.html'"></i>
    </footer>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyAmfVO3bXxDkdujx8frw5e5h9Rc4heNv9A", authDomain: "unarv-33742.firebaseapp.com", projectId: "unarv-33742" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Date Setup
        const d = new Date();
        const day = d.getDay(), diff = d.getDate() - day + (day == 0 ? -6 : 1);
        document.getElementById('returnDate').valueAsDate = new Date(d.setDate(diff));

        let investments = [];
        let todaysReturns = {};

        async function loadData() {
            const date = document.getElementById('returnDate').value;
            const container = document.getElementById('invList');
            container.innerHTML = '<div class="text-center text-white mt-5">Loading...</div>';

            // Load Investments
            const invSnap = await db.collection('investments').where('status', '==', 'active').get();
            investments = invSnap.docs.map(doc => ({id: doc.id, ...doc.data()}));

            // Load Today's Payments
            const transSnap = await db.collection('investment_transactions').where('date', '==', date).get();
            todaysReturns = {};
            transSnap.forEach(doc => { todaysReturns[doc.data().invId] = doc.data(); });

            renderList();
        }
        loadData();

        document.getElementById('returnDate').addEventListener('change', loadData);

        function renderList() {
            const container = document.getElementById('invList');
            if(investments.length === 0) { container.innerHTML = '<div class="text-center text-white mt-5">No active investments.</div>'; return; }

            container.innerHTML = investments.map(inv => {
                const isPaid = !!todaysReturns[inv.id];
                const amt = isPaid ? todaysReturns[inv.id].amount : inv.weeklyReturn;
                
                return `
                <div class="inv-item ${isPaid ? 'paid-row' : ''}">
                    <div class="inv-header">
                        <span>${inv.userName}</span>
                        <small class="text-muted">(${inv.returnedWeeks}/${inv.installments})</small>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="small text-muted">Return Due: ₹${inv.weeklyReturn}</div>
                            <div class="small">Bal to Pay: <b>₹${inv.balanceToReturn}</b></div>
                        </div>
                        ${isPaid 
                            ? `<button class="btn btn-sm btn-success" disabled>Paid ₹${amt}</button>`
                            : `<button class="btn btn-sm btn-primary" onclick="payReturn('${inv.id}', ${inv.balanceToReturn}, ${inv.weeklyReturn})">Pay ₹${inv.weeklyReturn}</button>`
                        }
                    </div>
                </div>`;
            }).join('');
        }

        window.payReturn = async function(invId, currentBal, amount) {
            if(!confirm(`Confirm return payment of ₹${amount}?`)) return;
            
            try {
                const date = document.getElementById('returnDate').value;

                // 1. Add Transaction
                await db.collection('investment_transactions').add({
                    invId: invId,
                    amount: amount,
                    date: date,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                // 2. Update Investment (Reduce Balance we owe)
                const newBal = currentBal - amount;
                const status = newBal <= 0 ? 'closed' : 'active';

                await db.collection('investments').doc(invId).update({
                    balanceToReturn: newBal,
                    returnedWeeks: firebase.firestore.FieldValue.increment(1),
                    status: status
                });

                loadData(); // Refresh

            } catch (error) {
                alert(error.message);
            }
        };
    </script>
</body>
</html>
