<!DOCTYPE html>
<html lang="ml" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>My Loans</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-orange: #FF6B35;
            --gradient: linear-gradient(135deg, #FF6B35 0%, #FF8C42 50%, #FFA726 100%);
            --card-bg: rgba(255, 255, 255, 0.95);
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --text-color: #333;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            color: var(--text-color);
            padding-top: 80px; 
            padding-bottom: 60px;
        }

        /* Fixed Header */
        .header-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 60px;
            background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px);
            display: flex; justify-content: center; align-items: center;
            z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header-image { height: 40px; width: auto; object-fit: contain; }

        /* Content */
        .content-wrapper { padding: 0 15px; display: flex; flex-direction: column; align-items: center; width: 100%; }

        .page-title { color: white; font-weight: 600; font-size: 1.4rem; margin-bottom: 20px; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }

        /* Summary Box */
        .total-box {
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
            border-radius: 10px; padding: 15px; color: white; text-align: center;
            width: 100%; max-width: 500px; margin-bottom: 20px;
        }

        /* Loan Card */
        .loan-card {
            background: var(--card-bg); border-radius: 15px; padding: 20px;
            width: 100%; max-width: 500px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px; position: relative; overflow: hidden;
        }

        .loan-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .loan-badge { background: #333; color: white; padding: 3px 10px; border-radius: 15px; font-size: 0.8rem; font-weight: 600; }
        .loan-status { font-size: 0.75rem; font-weight: 600; text-transform: uppercase; }
        .status-active { color: #10b981; }
        .status-closed { color: #666; }

        .grid-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .stat-item { background: #f8f9fa; padding: 10px; border-radius: 10px; text-align: center; }
        .stat-lbl { font-size: 0.7rem; color: #888; display: block; }
        .stat-val { font-size: 1rem; font-weight: 700; color: #333; }

        /* Progress Bar */
        .progress-container { height: 6px; background: #eee; border-radius: 3px; margin: 15px 0; overflow: hidden; }
        .progress-bar { height: 100%; background: var(--gradient); border-radius: 3px; transition: width 1s ease; }
        .progress-text { font-size: 0.75rem; color: #666; display: flex; justify-content: space-between; margin-bottom: 5px;}

        /* Transactions Inside Card */
        .trans-section { border-top: 1px dashed #ddd; padding-top: 15px; margin-top: 10px; }
        .trans-title { font-size: 0.85rem; font-weight: 600; margin-bottom: 10px; color: #555; }
        .trans-row { display: flex; justify-content: space-between; font-size: 0.85rem; padding: 6px 0; border-bottom: 1px solid #f0f0f0; }
        .trans-row:last-child { border-bottom: none; }
        .t-date { color: #666; }
        .t-amt { color: #10b981; font-weight: 600; }

        /* Footer */
        .footer {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 50px;
            background: var(--card-bg); border-top: 1px solid rgba(255, 107, 53, 0.3);
            display: flex; justify-content: center; align-items: center; z-index: 1000;
        }
        .home-icon { font-size: 1.2rem; color: var(--primary-orange); cursor: pointer; }
        .footer-text { font-size: 0.7rem; margin-left: 10px; font-weight: 500; color: #666; }

    </style>
</head>
<body>

    <header class="header-container">
        <img src="head.png" alt="Header" class="header-image" onerror="this.style.display='none'">
    </header>

    <main class="content-wrapper">
        <h1 class="page-title">My Loans</h1>

        <div class="total-box">
            <small>Total Outstanding Balance</small>
            <div style="font-size: 1.8rem; font-weight: 700;" id="totalLiability">...</div>
        </div>

        <div id="loansList">
            <div class="text-center text-white mt-5">
                <i class="fas fa-spinner fa-spin fa-2x"></i>
                <p class="mt-2">Fetching your loans...</p>
            </div>
        </div>
    </main>

    <footer class="footer">
        <i class="fas fa-home home-icon" onclick="window.location.href='index.html'"></i>
        <span class="footer-text">VTSoft 2025</span>
    </footer>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyAmfVO3bXxDkdujx8frw5e5h9Rc4heNv9A", authDomain: "unarv-33742.firebaseapp.com", projectId: "unarv-33742" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        auth.onAuthStateChanged(user => {
            if (user) {
                loadUserLoans(user.uid);
            } else {
                window.location.href = 'login.html';
            }
        });

        async function loadUserLoans(uid) {
            const container = document.getElementById('loansList');
            
            try {
                // 1. Fetch Active Loans for User
                const loansSnap = await db.collection('loans')
                    .where('userId', '==', uid)
                    .get();

                if (loansSnap.empty) {
                    container.innerHTML = '<div class="text-center text-white" style="opacity:0.8">No active loans found.</div>';
                    document.getElementById('totalLiability').innerText = "₹0";
                    return;
                }

                let html = '';
                let totalBal = 0;

                // 2. Iterate through each loan
                // Using Promise.all to fetch transactions for each loan in parallel
                const loanPromises = loansSnap.docs.map(async (doc) => {
                    const loan = doc.data();
                    const loanId = doc.id;
                    totalBal += (parseFloat(loan.balance) || 0);

                    // Calculate Progress
                    const totalAmt = parseFloat(loan.amount);
                    const balAmt = parseFloat(loan.balance);
                    const paidAmt = totalAmt - balAmt;
                    const percent = Math.min(100, Math.round((paidAmt / totalAmt) * 100));

                    // 3. Fetch Recent Transactions for THIS loan
                    // No orderBy in query to prevent index error, sort in JS
                    const transSnap = await db.collection('loan_transactions')
                        .where('loanNo', '==', loan.loanNo)
                        .limit(10) 
                        .get();

                    let transactions = [];
                    transSnap.forEach(tDoc => transactions.push(tDoc.data()));
                    // Sort by Date Descending
                    transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
                    // Take only last 3
                    const recentTrans = transactions.slice(0, 3);

                    // Generate Transaction HTML
                    let transHtml = '';
                    if (recentTrans.length > 0) {
                        transHtml = recentTrans.map(t => `
                            <div class="trans-row">
                                <span class="t-date">${formatDate(t.date)}</span>
                                <span class="t-amt">+ ₹${t.amount}</span>
                            </div>
                        `).join('');
                    } else {
                        transHtml = '<div class="text-muted small text-center">No payments yet</div>';
                    }

                    return `
                    <div class="loan-card">
                        <div class="loan-header">
                            <span class="loan-badge">#${loan.loanNo}</span>
                            <span class="loan-status ${loan.status === 'active' ? 'status-active' : 'status-closed'}">
                                ${loan.status.toUpperCase()}
                            </span>
                        </div>

                        <div class="progress-text">
                            <span>Repayment Progress</span>
                            <span>${percent}%</span>
                        </div>
                        <div class="progress-container">
                            <div class="progress-bar" style="width: ${percent}%"></div>
                        </div>
                        <div class="text-end mb-3" style="font-size:0.8rem; color:#666;">
                            <b>${loan.paidWeeks || 0}</b> of <b>${loan.installments}</b> Installments Paid
                        </div>

                        <div class="grid-stats">
                            <div class="stat-item">
                                <span class="stat-lbl">Loan Amount</span>
                                <span class="stat-val">₹${loan.amount}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-lbl">Balance</span>
                                <span class="stat-val text-danger">₹${loan.balance}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-lbl">Weekly Due</span>
                                <span class="stat-val">₹${loan.weeklyAmount}</span>
                            </div>
                        </div>

                        <div class="trans-section">
                            <div class="trans-title">Recent Payments</div>
                            ${transHtml}
                            <div class="text-center mt-2">
                                <small style="font-size:0.7rem; color:#aaa;">Showing last 3 transactions</small>
                            </div>
                        </div>
                    </div>
                    `;
                });

                const cards = await Promise.all(loanPromises);
                container.innerHTML = cards.join('');
                document.getElementById('totalLiability').innerText = `₹${totalBal.toLocaleString()}`;

            } catch (error) {
                console.error(error);
                container.innerHTML = `<div class="text-center text-white">Error loading loans.</div>`;
            }
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const parts = dateStr.split('-');
            if(parts.length === 3) return `${parts[2]}/${parts[1]}`; // DD/MM (Short format)
            return dateStr;
        }
    </script>
</body>
</html>
