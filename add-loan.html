<!DOCTYPE html>
<html lang="ml" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Add New Loan</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-orange: #FF6B35;
            --gradient: linear-gradient(135deg, #FF6B35 0%, #FF8C42 50%, #FFA726 100%);
            --card-bg: rgba(255, 255, 255, 0.95);
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --text-color: #333;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            color: var(--text-color);
            padding-top: 70px; 
            padding-bottom: 50px;
        }

        /* Fixed Header */
        .header-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 60px;
            background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px);
            display: flex; justify-content: center; align-items: center;
            z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header-image { height: 40px; width: auto; object-fit: contain; }

        /* Content */
        .content-wrapper {
            padding: 15px; display: flex; flex-direction: column; align-items: center;
        }

        .card-custom {
            background: var(--card-bg); border-radius: 15px; padding: 20px;
            width: 100%; max-width: 500px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .loan-badge {
            background: #333; color: white; padding: 5px 15px;
            border-radius: 20px; font-weight: 600; font-size: 1.2rem;
        }

        /* Search Results */
        .search-results {
            background: white; border: 1px solid #ddd; max-height: 150px;
            overflow-y: auto; display: none; position: absolute; width: 100%; z-index: 100;
            border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .search-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; }
        .search-item:hover { background: #f0f0f0; }

        .form-label { font-weight: 500; font-size: 0.9rem; margin-bottom: 5px; }
        
        /* Auto Calculation Display */
        .calc-display {
            background: #e0f2fe; color: #0369a1; padding: 10px;
            border-radius: 8px; font-size: 0.9rem; margin-top: 5px;
            border: 1px dashed #0369a1;
        }

        .btn-save {
            background: var(--gradient); border: none; width: 100%;
            padding: 12px; color: white; border-radius: 8px;
            font-weight: 600; margin-top: 15px;
            box-shadow: 0 4px 10px rgba(255, 107, 53, 0.3);
        }

        /* Fixed Footer */
        .footer {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 40px;
            background: var(--card-bg); border-top: 1px solid rgba(255, 107, 53, 0.3);
            display: flex; justify-content: center; align-items: center;
            z-index: 1000; font-size: 0.8rem; font-weight: 500; color: #666;
        }

    </style>
</head>
<body>

    <header class="header-container">
        <img src="head.png" alt="Header" class="header-image" onerror="this.style.display='none'">
    </header>

    <main class="content-wrapper">
        
        <div class="text-center mb-4">
            <small class="text-white d-block mb-1">New Loan Number</small>
            <span id="newLoanNo" class="loan-badge">...</span>
        </div>

        <div class="card-custom">
            <form id="loanForm">
                
                <div class="mb-3 position-relative">
                    <label class="form-label">Select Loan Taker</label>
                    <input type="text" id="memberSearch" class="form-control" placeholder="Search Member Name..." autocomplete="off">
                    <div id="memberResults" class="search-results"></div>
                    <input type="hidden" id="selectedMemberId">
                    <input type="hidden" id="selectedMemberName">
                </div>

                <div class="mb-3 position-relative">
                    <label class="form-label">Select Surety (Class A Only)</label>
                    <input type="text" id="suretySearch" class="form-control" placeholder="Search Surety..." autocomplete="off">
                    <div id="suretyResults" class="search-results"></div>
                    <input type="hidden" id="selectedSuretyId">
                    <input type="hidden" id="selectedSuretyName">
                </div>

                <div class="mb-3">
                    <label class="form-label">Sanction Amount (₹)</label>
                    <input type="number" id="amount" class="form-control" placeholder="Ex: 5000" required>
                    
                    <div id="repayDisplay" class="calc-display" style="display:none;">
                        Sanction: ₹0 | +10% Charge<br>
                        <b>Total Repayment: ₹0</b>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-6">
                        <label class="form-label">Installments</label>
                        <input type="number" id="installments" class="form-control" placeholder="Weeks" required>
                    </div>
                    <div class="col-6">
                        <label class="form-label">Weekly Amount</label>
                        <input type="number" id="weeklyAmt" class="form-control" required>
                    </div>
                </div>

                <button type="submit" class="btn-save">Create Loan</button>
            </form>
        </div>

    </main>

    <footer class="footer">
        Powered by VTSoft 2026
    </footer>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyAmfVO3bXxDkdujx8frw5e5h9Rc4heNv9A", authDomain: "unarv-33742.firebaseapp.com", projectId: "unarv-33742" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let allMembers = [];

        // 1. Auto Generate Loan Number
        async function generateLoanNo() {
            try {
                const snap = await db.collection('loans').orderBy('loanNo', 'desc').limit(1).get();
                let nextNo = 1000;
                if (!snap.empty) {
                    nextNo = parseInt(snap.docs[0].data().loanNo) + 1;
                }
                document.getElementById('newLoanNo').innerText = nextNo;
            } catch (e) {
                console.error(e);
                document.getElementById('newLoanNo').innerText = "1000";
            }
        }
        generateLoanNo();

        // 2. Load All Members
        db.collection('users').get().then(snap => {
            snap.forEach(doc => allMembers.push({id: doc.id, ...doc.data()}));
        });

        // 3. Search Function with Filter Logic
        function setupSearch(inputId, resultId, hiddenId, hiddenName, filterClassAOnly = false) {
            const input = document.getElementById(inputId);
            const results = document.getElementById(resultId);
            
            input.addEventListener('input', () => {
                const term = input.value.toLowerCase();
                if (term.length < 1) { results.style.display = 'none'; return; }
                
                // Filter Logic
                let filtered = allMembers.filter(m => m.name.toLowerCase().includes(term));
                
                // If this is for Surety, Filter only Class A
                if (filterClassAOnly) {
                    filtered = filtered.filter(m => m.memberClass === 'A');
                }

                if(filtered.length === 0) {
                    results.innerHTML = `<div class="search-item text-muted">No matching ${filterClassAOnly ? 'Class A ' : ''}member found</div>`;
                } else {
                    results.innerHTML = filtered.map(m => 
                        `<div class="search-item" onclick="select('${m.id}', '${m.name}', '${inputId}', '${resultId}', '${hiddenId}', '${hiddenName}')">
                            <span class="fw-bold">${m.name}</span> 
                            <small class="text-muted">(Class ${m.memberClass || 'A'})</small>
                        </div>`
                    ).join('');
                }
                results.style.display = 'block';
            });
        }

        window.select = function(id, name, inputId, resultId, hiddenId, hiddenName) {
            document.getElementById(inputId).value = name;
            document.getElementById(hiddenId).value = id;
            document.getElementById(hiddenName).value = name;
            document.getElementById(resultId).style.display = 'none';
        }

        // Setup Searches
        setupSearch('memberSearch', 'memberResults', 'selectedMemberId', 'selectedMemberName', false); // All Members
        setupSearch('suretySearch', 'suretyResults', 'selectedSuretyId', 'selectedSuretyName', true);  // Class A Only

        // 4. Auto Calculate 10% Service Charge
        const amountInput = document.getElementById('amount');
        const repayDisplay = document.getElementById('repayDisplay');

        amountInput.addEventListener('input', function() {
            const val = parseFloat(this.value);
            if(val > 0) {
                const total = val + (val * 0.10); // Adding 10%
                repayDisplay.style.display = 'block';
                repayDisplay.innerHTML = `Sanction: ₹${val} | +10% Charge<br><b>Total Repayment: ₹${total}</b>`;
            } else {
                repayDisplay.style.display = 'none';
            }
        });

        // 5. Create Loan
        document.getElementById('loanForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.querySelector('.btn-save');
            btn.innerHTML = 'Creating...';
            btn.disabled = true;

            try {
                const loanNo = document.getElementById('newLoanNo').innerText;
                const memberId = document.getElementById('selectedMemberId').value;
                const amount = parseFloat(document.getElementById('amount').value);
                
                if(!memberId) { alert('Please select a member'); throw new Error("No Member Selected"); }
                if(!amount) { alert('Enter amount'); throw new Error("No Amount"); }

                // Calculate Balance with 10% Charge
                const totalRepayable = amount + (amount * 0.10);

                const data = {
                    loanNo: parseInt(loanNo),
                    userId: memberId,
                    userName: document.getElementById('selectedMemberName').value,
                    suretyId: document.getElementById('selectedSuretyId').value || null,
                    suretyName: document.getElementById('selectedSuretyName').value || 'None',
                    
                    sanctionAmount: amount, // Actual money given
                    amount: totalRepayable, // Total debt (for compatibility with display logic)
                    balance: totalRepayable, // Starting balance is total debt
                    
                    installments: parseInt(document.getElementById('installments').value),
                    weeklyAmount: parseFloat(document.getElementById('weeklyAmt').value),
                    status: 'active',
                    startDate: firebase.firestore.FieldValue.serverTimestamp(),
                    paidWeeks: 0
                };

                await db.collection('loans').add(data);
                alert(`✅ Loan Created!\nAmount Given: ₹${amount}\nTo Repay: ₹${totalRepayable}`);
                window.location.reload();

            } catch (error) {
                console.error(error);
                if(error.message !== "No Member Selected") alert(error.message);
            } finally {
                btn.innerHTML = 'Create Loan';
                btn.disabled = false;
            }
        });
    </script>
</body>
</html>
