<!DOCTYPE html>
<html lang="ml" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loan Details</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary-orange: #FF6B35; --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        body { font-family: 'Poppins', sans-serif; background: var(--bg-gradient); min-height: 100vh; padding: 20px; }
        .card-custom { background: white; border-radius: 10px; padding: 15px; margin-bottom: 10px; }
        .trans-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
    </style>
</head>
<body>

    <button class="btn btn-light mb-3" onclick="window.history.back()"><i class="fas fa-arrow-left"></i> Back</button>

    <div class="card-custom" id="loanInfo">
        Loading Details...
    </div>

    <h6 class="text-white mt-4">Transactions</h6>
    <div class="card-custom" id="transList">
        Loading...
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyAmfVO3bXxDkdujx8frw5e5h9Rc4heNv9A", authDomain: "unarv-33742.firebaseapp.com", projectId: "unarv-33742" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const loanNo = parseInt(localStorage.getItem('currentLoanNo'));
        let loanDocId = '';

        async function loadData() {
            // 1. Get Loan Info
            const loanSnap = await db.collection('loans').where('loanNo', '==', loanNo).get();
            if (loanSnap.empty) return;
            
            const loan = loanSnap.docs[0].data();
            loanDocId = loanSnap.docs[0].id;

            document.getElementById('loanInfo').innerHTML = `
                <h3 class="text-primary">#${loan.loanNo}</h3>
                <h5>${loan.userName}</h5>
                <hr>
                <div class="d-flex justify-content-between">
                    <span>Sanctioned: <b>₹${loan.amount}</b></span>
                    <span>Balance: <b class="text-danger">₹${loan.balance}</b></span>
                </div>
                <small class="text-muted">Weekly: ₹${loan.weeklyAmount} | Weeks: ${loan.installments}</small>
            `;

            // 2. Get Transactions
            const transSnap = await db.collection('loan_transactions')
                .where('loanNo', '==', loanNo)
                .orderBy('date', 'desc')
                .get();

            const transList = document.getElementById('transList');
            transList.innerHTML = transSnap.docs.map(doc => {
                const t = doc.data();
                return `
                <div class="trans-item">
                    <div>
                        <strong>₹${t.amount}</strong><br>
                        <small class="text-muted">${t.date}</small>
                    </div>
                    <button class="btn btn-sm btn-outline-primary" onclick="editTrans('${doc.id}', ${t.amount})">
                        <i class="fas fa-pen"></i>
                    </button>
                </div>`;
            }).join('');
        }
        loadData();

        window.editTrans = async function(transId, oldAmount) {
            const newAmount = prompt("Enter new amount:", oldAmount);
            if (newAmount && newAmount != oldAmount) {
                const diff = parseFloat(oldAmount) - parseFloat(newAmount);
                
                // Update Transaction
                await db.collection('loan_transactions').doc(transId).update({ amount: parseFloat(newAmount) });
                
                // Update Loan Balance (Reverse logic: if paid less, balance increases)
                await db.collection('loans').doc(loanDocId).update({
                    balance: firebase.firestore.FieldValue.increment(diff)
                });
                
                alert("Updated!");
                loadData();
            }
        };
    </script>
</body>
</html>
