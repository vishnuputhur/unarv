<!DOCTYPE html>
<html lang="ml" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Loans</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary-orange: #FF6B35; --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        body { font-family: 'Poppins', sans-serif; background: var(--bg-gradient); min-height: 100vh; padding-top: 130px; padding-bottom: 70px; }
        
        /* Sticky Header */
        .top-controls {
            position: fixed; top: 0; left: 0; width: 100%;
            background: white; padding: 15px; z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        /* Loan List */
        .loan-item {
            background: rgba(255,255,255,0.95); border-radius: 12px;
            margin: 10px 15px; padding: 15px;
            display: flex; flex-direction: column;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            transition: all 0.3s;
        }

        .loan-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; cursor: pointer;}
        
        .loan-badge { 
            background: #333; color: white; padding: 2px 8px; 
            border-radius: 6px; font-size: 0.75rem; font-weight: 600; 
        }
        
        .inst-badge {
            background: #e0e7ff; color: #4338ca; 
            padding: 2px 8px; border-radius: 6px; 
            font-size: 0.75rem; font-weight: 700; margin-left: 5px;
        }

        .loan-name { font-weight: 600; font-size: 1rem; margin-left: 8px; color: #333; }
        
        .action-row { display: flex; align-items: center; gap: 10px; }
        
        .info-col { font-size: 0.75rem; color: #666; line-height: 1.4; white-space: nowrap; }
        .text-due { color: #dc3545; font-weight: 600; }
        
        .form-control-custom { 
            border: 1px solid #ddd; border-radius: 8px; padding: 8px; 
            font-weight: 600; text-align: right; 
        }

        .btn-pay { 
            border-radius: 8px; width: 50px; height: 38px; 
            display: flex; align-items: center; justify-content: center; 
        }

        /* Already Paid State */
        .paid-row { border-left: 5px solid #10b981; }
        .paid-input { background-color: #f0fdf4; border-color: #10b981; color: #10b981; }

        /* Footer Total */
        .footer-total {
            position: fixed; bottom: 0; width: 100%; height: 50px;
            background: #fff; border-top: 1px solid #eee;
            display: flex; justify-content: space-between;
            align-items: center; padding: 0 20px; z-index: 1000;
        }
        .total-label { font-size: 0.9rem; color: #666; }
        .total-val { font-size: 1.2rem; font-weight: 700; color: #10b981; }

    </style>
</head>
<body>

    <div class="top-controls">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="m-0 fw-bold" style="color:#444;">Loan Collections</h5>
            <button onclick="window.location.href='admin.html'" class="btn btn-sm btn-light border"><i class="fas fa-home"></i></button>
        </div>
        <div class="row g-2">
            <div class="col-7">
                <input type="date" id="collectionDate" class="form-control form-control-sm fw-bold">
            </div>
            <div class="col-5">
                <input type="text" id="searchLoan" class="form-control form-control-sm" placeholder="Search...">
            </div>
        </div>
        <div id="loadingIndicator" class="text-center mt-1 text-primary" style="font-size:0.7rem; display:none;">
            <i class="fas fa-spinner fa-spin"></i> Checking existing records...
        </div>
    </div>

    <div id="loanList">
        </div>

    <div class="footer-total">
        <span class="total-label">Day Total:</span>
        <span id="dayTotal" class="total-val">₹0</span>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyAmfVO3bXxDkdujx8frw5e5h9Rc4heNv9A", authDomain: "unarv-33742.firebaseapp.com", projectId: "unarv-33742" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Global State
        let allLoans = [];
        let todaysTransactions = {}; // Map: loanId -> transactionData
        let daySum = 0;

        // 1. Initial Setup
        function setMonday() {
            const d = new Date();
            const day = d.getDay(), diff = d.getDate() - day + (day == 0 ? -6 : 1); 
            document.getElementById('collectionDate').valueAsDate = new Date(d.setDate(diff));
        }
        setMonday();

        // 2. Load Active Loans (Once)
        async function init() {
            document.getElementById('loadingIndicator').style.display = 'block';
            
            // Fetch Loans
            const snap = await db.collection('loans').where('status', '==', 'active').get();
            allLoans = snap.docs.map(doc => ({id: doc.id, ...doc.data()}));
            
            // Load Transactions for the default date
            await loadTransactionsForDate();
        }
        init();

        // 3. Listen for Date Change
        document.getElementById('collectionDate').addEventListener('change', async () => {
            await loadTransactionsForDate();
        });

        // 4. Fetch Transactions for Selected Date
        async function loadTransactionsForDate() {
            const date = document.getElementById('collectionDate').value;
            const indicator = document.getElementById('loadingIndicator');
            
            indicator.style.display = 'block';
            indicator.innerHTML = `<i class="fas fa-sync fa-spin"></i> Loading data for ${date}...`;

            todaysTransactions = {}; // Reset
            daySum = 0;

            try {
                // Query transactions for this specific date
                const snap = await db.collection('loan_transactions')
                    .where('date', '==', date)
                    .get();

                snap.forEach(doc => {
                    const data = doc.data();
                    todaysTransactions[data.loanId] = data; // Store using Loan ID as key
                    daySum += parseFloat(data.amount);
                });

                renderList(); // Re-render the UI with new data

            } catch (error) {
                console.error("Error loading transactions:", error);
            } finally {
                indicator.style.display = 'none';
            }
        }

        // 5. Render Logic
        function renderList(filteredLoans = null) {
            const container = document.getElementById('loanList');
            const loansToRender = filteredLoans || allLoans;
            
            if(loansToRender.length === 0) {
                container.innerHTML = '<div class="text-center text-white mt-5">No active loans found.</div>';
                return;
            }

            container.innerHTML = loansToRender.map(loan => {
                const trans = todaysTransactions[loan.id]; // Check if paid today
                const isPaid = !!trans; // Boolean: true if paid
                
                // If paid, show paid amount. If not, show default weekly amount
                const displayAmount = isPaid ? trans.amount : loan.weeklyAmount;
                const rowClass = isPaid ? 'paid-row' : '';
                const inputClass = isPaid ? 'paid-input' : '';
                
                // Installment Counter logic
                // Currently paid weeks + 1 (if not paid today)
                const currentInst = isPaid ? loan.paidWeeks : (loan.paidWeeks + 1);
                const instBadge = `${loan.paidWeeks}/${loan.installments}`;

                return `
                <div class="loan-item ${rowClass}">
                    <div class="loan-header" onclick="viewDetails('${loan.loanNo}')">
                        <div class="d-flex align-items-center">
                            <span class="loan-badge">#${loan.loanNo}</span>
                            <span class="loan-name">${loan.userName}</span>
                            <span class="inst-badge" title="Installments Paid">${instBadge}</span>
                        </div>
                        <i class="fas fa-chevron-right text-muted" style="font-size:0.8rem"></i>
                    </div>
                    
                    <div class="action-row">
                        <div class="info-col">
                            <div>Due: <span class="text-due">₹${loan.weeklyAmount}</span></div>
                            <div>Bal: ₹${loan.balance}</div>
                        </div>
                        
                        <input type="number" 
                               class="form-control form-control-custom ${inputClass}" 
                               id="amt_${loan.id}" 
                               value="${displayAmount}" 
                               ${isPaid ? 'readonly' : ''}> ${isPaid 
                            ? `<button class="btn btn-sm btn-success btn-pay" disabled><i class="fas fa-check-double"></i></button>` 
                            : `<button class="btn btn-sm btn-outline-primary btn-pay" onclick="pay('${loan.id}', ${loan.balance}, '${loan.userName}')"><i class="fas fa-save"></i></button>`
                        }
                    </div>
                </div>
                `;
            }).join('');

            // Update Total Footer
            document.getElementById('dayTotal').innerText = `₹${daySum.toLocaleString()}`;
        }

        // 6. Pay Function
        window.pay = async function(loanId, currentBalance, name) {
            const amountInput = document.getElementById(`amt_${loanId}`);
            const amount = parseFloat(amountInput.value);
            const date = document.getElementById('collectionDate').value;

            // Security Check: Is it Monday? (Optional warning, not blocking as per request)
            /*
            const d = new Date(date);
            if(d.getDay() !== 1) {
                if(!confirm("Warning: The selected date is NOT a Monday. Continue?")) return;
            }
            */

            if(!amount || amount <= 0) { alert("Enter valid amount"); return; }

            // Prevent Double Entry (Client Side Check)
            if(todaysTransactions[loanId]) {
                alert("Payment already recorded for this date! Refreshing...");
                loadTransactionsForDate();
                return;
            }

            const btn = event.currentTarget;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            btn.disabled = true;

            try {
                // A. Add Transaction
                await db.collection('loan_transactions').add({
                    loanId: loanId,
                    loanNo: allLoans.find(l=>l.id==loanId).loanNo,
                    amount: amount,
                    date: date,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                // B. Update Loan Balance & Paid Weeks
                const newBal = currentBalance - amount;
                const newStatus = newBal <= 0 ? 'closed' : 'active';
                
                await db.collection('loans').doc(loanId).update({
                    balance: newBal,
                    paidWeeks: firebase.firestore.FieldValue.increment(1),
                    status: newStatus
                });

                // C. Update Local State (Optimistic Update)
                // We add this to todaysTransactions so the UI updates instantly
                todaysTransactions[loanId] = { amount: amount };
                daySum += amount;
                
                // Update the specific loan object in allLoans to reflect new balance locally
                const loanIdx = allLoans.findIndex(l => l.id == loanId);
                if(loanIdx > -1) {
                    allLoans[loanIdx].balance = newBal;
                    allLoans[loanIdx].paidWeeks += 1;
                }

                // Re-render
                renderList(); 

            } catch (error) {
                alert("Error: " + error.message);
                btn.innerHTML = '<i class="fas fa-save"></i>';
                btn.disabled = false;
            }
        };

        // View Details
        window.viewDetails = function(loanNo) {
            localStorage.setItem('currentLoanNo', loanNo);
            window.location.href = 'loan-details.html';
        };
        
        // Search Filter
        document.getElementById('searchLoan').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            const filtered = allLoans.filter(l => 
                l.userName.toLowerCase().includes(term) || 
                l.loanNo.toString().includes(term)
            );
            renderList(filtered);
        });

    </script>
</body>
</html>
